# nsjail configuration for Req2Run benchmark execution
# This configuration provides a secure sandbox for code evaluation

name: "req2run_sandbox"

# Execution mode
mode: ONCE
hostname: "sandbox"
cwd: "/app"

# Time limits
time_limit: 300  # 5 minutes max execution time
max_cpus: 2

# Resource limits
rlimit_as: 2048  # 2GB virtual memory
rlimit_cpu: 300  # 5 minutes CPU time
rlimit_fsize: 104857600  # 100MB max file size
rlimit_nofile: 256  # Max open files

# User/Group
uid: 1000
gid: 1000

# Mount points
mount {
    src: "/app"
    dst: "/app"
    is_bind: true
    rw: true
}

mount {
    src: "/tmp"
    dst: "/tmp"
    is_bind: true
    rw: true
    is_dir: true
}

# Read-only system mounts
mount {
    src: "/usr"
    dst: "/usr"
    is_bind: true
    rw: false
}

mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
    rw: false
}

mount {
    src: "/lib64"
    dst: "/lib64"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/bin"
    dst: "/bin"
    is_bind: true
    rw: false
}

mount {
    src: "/sbin"
    dst: "/sbin"
    is_bind: true
    rw: false
}

# Python/Node/Go specific paths
mount {
    src: "/usr/local"
    dst: "/usr/local"
    is_bind: true
    rw: false
}

# Proc filesystem (limited)
mount {
    dst: "/proc"
    fstype: "proc"
    rw: false
}

# Dev filesystem
mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/random"
    dst: "/dev/random"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
    rw: true
}

# Network isolation
clone_newnet: true
clone_newpid: true
clone_newipc: true

# Seccomp-bpf policy
seccomp_string: "
    ALLOW {
        read, write, close, fstat, lseek, 
        mmap, mprotect, munmap, brk,
        rt_sigaction, rt_sigprocmask, rt_sigreturn,
        ioctl, nanosleep, select, poll,
        dup, dup2, fcntl, 
        getpid, getuid, getgid, geteuid, getegid,
        getppid, getpgrp, 
        sigaltstack, 
        exit_group, exit,
        uname, 
        getrlimit, 
        getrusage,
        arch_prctl,
        gettimeofday,
        time,
        futex,
        set_tid_address,
        clock_gettime,
        set_robust_list,
        pipe, pipe2,
        clone, fork, vfork, execve,
        wait4, waitpid,
        kill,
        openat, 
        newfstatat,
        readlink,
        access, faccessat,
        pread64, pwrite64,
        getcwd,
        getdents, getdents64,
        mkdir, mkdirat,
        unlink, unlinkat,
        rename, renameat,
        rmdir,
        symlink, symlinkat,
        chmod, fchmod, fchmodat,
        chown, fchown, fchownat,
        umask,
        mremap,
        prctl,
        sysinfo,
        getrandom,
        sched_yield,
        sched_getaffinity,
        sigaction
    }
    DEFAULT ERRNO(1)
"

# Logging
log_level: WARNING
log_fd: 2  # stderr

# Keep capabilities empty for maximum restriction
keep_caps: false

# No new privileges
no_new_privs: true